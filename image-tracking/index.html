<!-- import aframe and then ar.js with image tracking / location based features -->
<script src="https://cdn.jsdelivr.net/npm/aframe@1.6.0/dist/aframe-master.min.js"></script>
<script src="https://unpkg.com/aframe-event-set-component@5.0.0/dist/aframe-event-set-component.min.js"></script>

<script src="../assets/aframe-ar-nft.js"></script>
<!-- <script src="../assets/aframe-ar.js"></script> -->
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script> -->
<!-- style for the loader -->
<style>
  .arjs-loader {
    height: 100%;
    width: 100%;
    position: absolute;
    top: 0;
    left: 0;
    background-color: rgba(0, 0, 0, 0.8);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .arjs-loader div {
    text-align: center;
    font-size: 1.25em;
    color: white;
  }

  /* Popup styles */
  .popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 20px;
    border-radius: 10px;
    border: 2px solid #4CC3D9;
    z-index: 10001;
    display: none;
    max-width: 80%;
    text-align: center;
    font-family: Arial, sans-serif;
  }

  .popup h3 {
    margin: 0 0 10px 0;
    color: #4CC3D9;
  }

  .popup p {
    margin: 0 0 15px 0;
    line-height: 1.4;
  }

  .popup button {
    background: #4CC3D9;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
  }

  .popup button:hover {
    background: #8FF7FF;
    color: #000;
  }
</style>

<body style="margin : 0px; overflow: hidden;">
  <!-- minimal loader shown until image descriptors are loaded. Loading may take a while according to the device computational power -->
  <div class="arjs-loader">
    <div>Loading, please wait...</div>
  </div>

  <!-- Popup for model interaction -->
  <div id="model-popup" class="popup">
    <h3>Model Information</h3>
    <p>You've touched the 3D model! This is an interactive AR experience.</p>
    <p>The model is tracked using NFT (Natural Feature Tracking) technology.</p>
    <button onclick="closePopup()">Close</button>
  </div>

  <!-- a-frame scene -->
  <a-scene
    vr-mode-ui="enabled: false;"
    renderer="logarithmicDepthBuffer: true;"
    embedded
    arjs="trackingMethod: best; sourceType: webcam;debugUIEnabled: true;"
    stats
  >
    <!-- a-nft is the anchor that defines an Image Tracking entity -->
    <!-- on 'url' use the path to the Image Descriptors created before. -->
    <!-- the path should end with the name without the extension e.g. if file is 'pinball.fset' the path should end with 'pinball' -->
    <a-nft
      type="nft"
      url="AR-demo/image-tracking/image-2"
      emitevents="true"
      smooth="true"
      smoothCount="10"
      smoothTolerance=".01"
      smoothThreshold="5"
    >
      <!-- as a child of the a-nft entity, you can define the content to show. here's a GLTF model entity -->
      <a-entity
        gltf-model="https://vazxmixjsiawhamofees.supabase.co/storage/v1/object/public/models/anvil/model.gltf"
        scale="50 50 50"
        position="0 0 0"
        id="interactive-model"
        event-set__click="_event: click; _target: #model-popup; style: display: block"
        event-set__mouseenter="_event: mouseenter; material: color: #8FF7FF"
        event-set__mouseleave="_event: mouseleave; material: color: #4CC3D9"
      >
      </a-entity>
    </a-nft>
    <!-- static camera that moves according to the device movemenents -->
    <a-entity camera>
      <a-cursor></a-cursor>
    </a-entity>
  </a-scene>
  
  <!-- Debug overlay -->
  <div id="debug-overlay" style="position: fixed; bottom: 8px; left: 8px; right: 8px; max-height: 40vh; overflow: auto; background: rgba(0,0,0,0.7); color: #0f0; font: 12px/1.4 monospace; padding: 8px; z-index: 10000; border: 1px solid #0f0;">
    <div><strong>AR Debug</strong> — <span id="debug-status">initializing…</span></div>
    <pre id="debug-log" style="white-space: pre-wrap; margin: 6px 0 0 0;"></pre>
  </div>
  
  <script>
    // Popup control functions
    function closePopup() {
      document.getElementById('model-popup').style.display = 'none';
    }

    // Close popup when clicking outside of it
    document.addEventListener('click', function(event) {
      var popup = document.getElementById('model-popup');
      if (event.target === popup || popup.contains(event.target)) {
        return;
      }
      popup.style.display = 'none';
    });

    (function () {
      var logEl = document.getElementById('debug-log');
      var statusEl = document.getElementById('debug-status');
      function now() {
        return new Date().toISOString().split('T')[1].replace('Z','');
      }
      function log() {
        var msg = Array.prototype.slice.call(arguments).map(function (a) {
          try { return typeof a === 'object' ? JSON.stringify(a) : String(a); } catch (e) { return String(a); }
        }).join(' ');
        var line = '[' + now() + '] ' + msg + '\n';
        if (logEl) { logEl.textContent += line; logEl.scrollTop = logEl.scrollHeight; }
        if (console && console.log) console.log('[ARDBG]', msg);
      }
      function setStatus(text) {
        if (statusEl) statusEl.textContent = text;
      }
      
      log('Document ready');
      
      // Global error hooks
      window.addEventListener('error', function (e) {
        log('Window error:', e.message, 'at', e.filename + ':' + e.lineno);
      });
      window.addEventListener('unhandledrejection', function (e) {
        log('Unhandled promise rejection:', e.reason && (e.reason.message || e.reason));
      });
      
      // Scene, AR.js, marker and model events
      var scene = document.querySelector('a-scene');
      var nft = document.querySelector('a-nft');
      var model = document.querySelector('a-entity[gltf-model]');
      
      if (scene) {
        var arOpts = scene.getAttribute('arjs');
        log('Scene found. arjs=', arOpts);
        setStatus('scene-found');
        
        scene.addEventListener('loaded', function () {
          log('Scene loaded');
        });
        scene.addEventListener('enter-vr', function () { log('enter-vr'); });
        scene.addEventListener('exit-vr', function () { log('exit-vr'); });
      } else {
        log('Scene NOT found');
      }
      
      // AR.js specific hooks (if available)
      document.addEventListener('arReady', function () {
        log('arReady');
        setStatus('ar-ready');
      });
      document.addEventListener('arError', function (e) {
        log('arError:', e && e.detail);
        setStatus('ar-error');
      });
      document.addEventListener('camera-init', function () { log('camera-init'); });
      document.addEventListener('camera-error', function (e) { log('camera-error', e && e.detail); });
      document.addEventListener('arjs-video-loaded', function () { log('arjs-video-loaded'); });
      
      if (nft) {
        nft.addEventListener('markerFound', function () {
          log('NFT markerFound');
          setStatus('marker-found');
        });
        nft.addEventListener('markerLost', function () {
          log('NFT markerLost');
          setStatus('marker-lost');
        });
      } else {
        log('a-nft NOT found');
      }
      
      if (model) {
        model.addEventListener('model-loaded', function (e) {
          var detail = e && e.detail ? Object.keys(e.detail) : 'no-detail';
          log('Model loaded', detail);
        });
        model.addEventListener('model-error', function (e) {
          log('Model error', e && e.detail && e.detail.src);
        });
      } else {
        log('GLTF entity NOT found');
      }
      
      // Periodic sampler for FPS and camera status
      setInterval(function () {
        try {
          var threeRenderer = scene && scene.renderer;
          var cam = scene && scene.camera;
          var ready = !!(threeRenderer && cam);
          setStatus((ready ? 'ok' : 'init') + ' | cam=' + (cam ? 'yes' : 'no'));
        } catch (e) {}
      }, 1000);
    })();
  </script>
</body>